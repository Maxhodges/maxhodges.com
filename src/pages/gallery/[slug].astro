---
import { getCollection } from "astro:content";
import { getImage } from "astro:assets";
import SiteLayout from "../../layouts/SiteLayout.astro";
import GallerySlider from "../../components/GallerySlider.svelte";

export async function getStaticPaths() {
  const galleries = await getCollection("galleries");
  return galleries
    .filter((gallery) => gallery.data.visible !== false)
    .map((gallery) => ({
      params: { slug: gallery.id },
      props: { gallery },
    }));
}

const { gallery } = Astro.props;
const widths = [480, 960, 1440];
const sizes = "(max-width: 768px) 92vw, 1440px";

const images = await Promise.all(
  gallery.data.images.map(async (image) => {
    const rawSrc = typeof image.src === "string" ? image.src : image.src.src;
    const cleanSrc = rawSrc.split("?")[0].split("#")[0];
    const fileName = cleanSrc.split("/").pop() ?? cleanSrc;
    const webp = await getImage({ src: image.src, widths, format: "webp" });
    const fallback = await getImage({ src: image.src, widths, format: "jpeg" });

    return {
      fileName,
      alt: image.alt,
      sources: [{ type: "image/webp", srcset: webp.srcSet.attribute, sizes }],
      fallback: {
        src: fallback.src,
        srcset: fallback.srcSet.attribute,
        sizes,
        width: fallback.attributes.width,
        height: fallback.attributes.height,
      },
    };
  }),
);
---

<SiteLayout
  title={`Max Hodges — ${gallery.data.title}`}
  breadcrumb={`Home / ${gallery.data.title}`}
>
  <script is:inline>
    const params = new URLSearchParams(window.location.search);
    if (params.has("gridview")) {
      document.documentElement.dataset.galleryView = "grid";
    }
  </script>
  <style>
    :root[data-gallery-view="grid"] .gallery-slider {
      display: none;
    }

    :root:not([data-gallery-view="grid"]) .gallery-grid {
      display: none;
    }
  </style>
  <section class="grid gap-10">
    <div class="flex flex-wrap items-end justify-between gap-6">
      <!-- <div>
        <h1 class="font-[var(--font-display)] text-4xl leading-tight sm:text-5xl">
          {gallery.data.title}
        </h1>
        <p class="mt-3 max-w-xl text-sm uppercase tracking-[0.2em] text-[color:var(--sea)]">
          Immersive sequence, navigable with arrows.
        </p>
      </div> -->
      <!-- <div
        class="rounded-full border border-[color:var(--rust)] px-4 py-2 text-xs uppercase tracking-[0.3em] text-[color:var(--rust)]"
      >
        Series
      </div> -->
    </div>

    <div class="gallery-slider">
      <GallerySlider images={images} client:load />
    </div>

    <div class="gallery-grid">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="font-[var(--font-display)] text-2xl">Contact Sheet</div>
        <div class="text-xs uppercase tracking-[0.3em] text-[color:var(--sea)]">
          {gallery.data.title}
        </div>
      </div>
      <div class="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {
          images.map((image, index) => (
            <figure class="rounded-2xl border border-white/10 bg-black/30 p-3">
              <picture>
                {image.sources.map((source) => (
                  <source type={source.type} srcset={source.srcset} sizes="(max-width: 768px) 45vw, 300px" />
                ))}
                <img
                  src={image.fallback.src}
                  srcset={image.fallback.srcset}
                  sizes="(max-width: 768px) 45vw, 300px"
                  width={image.fallback.width}
                  height={image.fallback.height}
                  alt={image.alt}
                  loading="lazy"
                  decoding="async"
                  class="h-64 w-full rounded-xl object-contain"
                />
              </picture>
              <figcaption class="mt-3 text-[10px] uppercase tracking-[0.2em] text-[color:var(--sea)]">
                {String(index + 1).padStart(2, "0")} — {image.fileName}
              </figcaption>
            </figure>
          ))
        }
      </div>
    </div>
  </section>
</SiteLayout>
